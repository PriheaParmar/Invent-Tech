{% extends "accounts/base_app.html" %}
{% load static %}

{% block title %}Dashboard - InventTech{% endblock %}

{% block page_title %}Good morning, {{ request.user.username|default:"Admin" }}{% endblock %}
{% block page_subtitle %}Track lots, programs, and dispatch in one system.{% endblock %}

{% block content %}

<!-- =========================================================
  SECTION 1: DASHBOARD
========================================================= -->
<section id="section-dashboard" class="page-section is-active">
  <div class="canvas">
    <section class="grid">

      <div class="card soft c1">
        <div class="card-head">
          <div>
            <div class="card-title">Inward (GRN)</div>
            <div class="card-sub">Today’s incoming materials</div>
          </div>
          <span class="pill">Live</span>
        </div>

        <div class="kpi">
          <div class="kpi-big">9</div>
          <div class="kpi-sub">pending GRNs</div>
        </div>

        <div class="mini-bars">
          <span style="height:18px"></span><span style="height:30px"></span><span style="height:14px"></span>
          <span style="height:34px"></span><span style="height:22px"></span><span style="height:28px"></span>
        </div>
      </div>

      <div class="card soft c2">
        <div class="card-head">
          <div>
            <div class="card-title">WIP Programs</div>
            <div class="card-sub">Cutting → Stitching → Finishing</div>
          </div>
          <span class="pill">Shift A</span>
        </div>

        <div class="kpi">
          <div class="kpi-big">38</div>
          <div class="kpi-sub">running programs</div>
        </div>

        <div class="chips">
          <span class="chip">Cutting: 11</span>
          <span class="chip">Stitching: 19</span>
          <span class="chip">Finishing: 8</span>
        </div>
      </div>

      <div class="card soft c3">
        <div class="card-head">
          <div>
            <div class="card-title">Dispatch</div>
            <div class="card-sub">Invoices • E-way • Challan</div>
          </div>
          <span class="pill">Today</span>
        </div>

        <div class="kpi">
          <div class="kpi-big">14</div>
          <div class="kpi-sub">scheduled</div>
        </div>

        <div class="chips">
          <span class="chip">Pending: 6</span>
          <span class="chip">Done: 8</span>
        </div>
      </div>

      <div class="card soft big c4">
        <div class="card-head">
          <div>
            <div class="card-title">Production Trend</div>
            <div class="card-sub">Last 14 days output</div>
          </div>
          <span class="pill">Overview</span>
        </div>

        <div class="chart">
          <div class="chart-grid"></div>
          <div class="chart-line"></div>
        </div>

        <div class="tiny-note">Later we connect this to real program + stock ledger data.</div>
      </div>

      <div class="card soft mid c5">
        <div class="card-head">
          <div>
            <div class="card-title">Stage Load</div>
            <div class="card-sub">Capacity snapshot</div>
          </div>
          <span class="pill">Now</span>
        </div>

        <div class="prog">
          <div class="row">
            <div class="nm">Cutting</div>
            <div class="bar"><span style="width:62%"></span></div>
            <div class="vl">62%</div>
          </div>
          <div class="row">
            <div class="nm">Stitching</div>
            <div class="bar"><span style="width:44%"></span></div>
            <div class="vl">44%</div>
          </div>
          <div class="row">
            <div class="nm">Finishing</div>
            <div class="bar"><span style="width:28%"></span></div>
            <div class="vl">28%</div>
          </div>
        </div>

        <div class="chips" style="margin-top:10px;">
          <span class="chip">QC Hold: 2</span>
          <span class="chip">Delayed: 5</span>
        </div>
      </div>

      <div class="card soft list c6">
        <div class="card-head">
          <div>
            <div class="card-title">Active Programs</div>
            <div class="card-sub">Recent production runs</div>
          </div>
          <a class="link" href="#">Show all</a>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Program</th>
              <th>Style</th>
              <th>Stage</th>
              <th>Qty</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>PRG-0091</td>
              <td>S-22</td>
              <td>Stitching</td>
              <td>2,400</td>
              <td><span class="status warn">In Progress</span></td>
            </tr>
            <tr>
              <td>PRG-0090</td>
              <td>S-18</td>
              <td>Cutting</td>
              <td>1,200</td>
              <td><span class="status ok">On Track</span></td>
            </tr>
            <tr>
              <td>PRG-0087</td>
              <td>S-12</td>
              <td>Finishing</td>
              <td>900</td>
              <td><span class="status bad">Delayed</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card soft list c7">
        <div class="card-head">
          <div>
            <div class="card-title">Lot Watch</div>
            <div class="card-sub">Lots needing attention</div>
          </div>
          <span class="pill">Alerts</span>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Lot</th>
              <th>Material</th>
              <th>Available</th>
              <th>State</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Y-102</td>
              <td>Yarn</td>
              <td>120 kg</td>
              <td><span class="status bad">Low</span></td>
            </tr>
            <tr>
              <td>G-211</td>
              <td>Greige</td>
              <td>480 m</td>
              <td><span class="status warn">QC</span></td>
            </tr>
            <tr>
              <td>T-044</td>
              <td>Trims</td>
              <td>2,600 pcs</td>
              <td><span class="status ok">OK</span></td>
            </tr>
          </tbody>
        </table>
      </div>

    </section>

    <aside class="right">
      <div class="card right-card">
        <div class="right-head">
          <div class="rh-title">May 2024</div>
          <span class="pill">Shift A</span>
        </div>

        <div class="calendar">
          <div class="wk">M</div>
          <div class="wk">T</div>
          <div class="wk">W</div>
          <div class="wk">T</div>
          <div class="wk">F</div>
          <div class="wk">S</div>
          <div class="wk">S</div>
          <div class="d">1</div>
          <div class="d">2</div>
          <div class="d">3</div>
          <div class="d">4</div>
          <div class="d">5</div>
          <div class="d">6</div>
          <div class="d">7</div>
          <div class="d">8</div>
          <div class="d">9</div>
          <div class="d">10</div>
          <div class="d">11</div>
          <div class="d active">12</div>
          <div class="d">13</div>
          <div class="d">14</div>
          <div class="d">15</div>
          <div class="d">16</div>
          <div class="d">17</div>
          <div class="d">18</div>
          <div class="d">19</div>
          <div class="d">20</div>
          <div class="d">21</div>
          <div class="d">22</div>
          <div class="d">23</div>
          <div class="d">24</div>
          <div class="d">25</div>
          <div class="d">26</div>
          <div class="d">27</div>
          <div class="d">28</div>
          <div class="d">29</div>
          <div class="d">30</div>
          <div class="d">31</div>
        </div>
      </div>

      <div class="card right-card">
        <div class="right-head">
          <div>
            <div class="card-title">Today’s Timeline</div>
            <div class="card-sub">Dispatch + GRN + checkpoints</div>
          </div>
          <span class="pill">May 12</span>
        </div>

        <div class="timeline">
          <div class="titem">
            <div class="t-time">09:30</div>
            <div class="t-dot"></div>
            <div>
              <div class="t-title">GRN Verification</div>
              <div class="t-sub">Yarn Lot Y-148 QC pending</div>
            </div>
          </div>
          <div class="titem">
            <div class="t-time">12:00</div>
            <div class="t-dot"></div>
            <div>
              <div class="t-title">Stitching Handover</div>
              <div class="t-sub">PRG-0091 bundle issue to line-3</div>
            </div>
          </div>
          <div class="titem">
            <div class="t-time">04:00</div>
            <div class="t-dot"></div>
            <div>
              <div class="t-title">Dispatch Window</div>
              <div class="t-sub">INV-00211 invoice + e-way</div>
            </div>
          </div>
        </div>
      </div>
    </aside>

  </div>
</section>


<!-- =========================================================
  SECTION 2: UTILITIES
========================================================= -->
<section id="section-utilities" class="page-section">
  <div class="canvas">
    <section class="grid util-grid-section">
      <div class="card soft big c8">

        <div class="card-head util-head">
          <div>
            <div class="card-title">Utilities</div>
            <div class="card-sub">Masters, setup, uploads & configuration — everything in one place.</div>
          </div>

          <div class="util-search">
            <svg class="ico" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M21 21l-4.3-4.3"></path>
              <path d="M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"></path>
            </svg>
            <input id="utilSearch" type="text"
              placeholder="Search utilities… (jobber, shade, greige, bom, catalogue)" />
          </div>
        </div>

        <div id="utilSections" class="util-sections"></div>

        <div class="tiny-note" style="margin-top:10px;">
          Clicking a tile will open the module inside dashboard (no new page).
        </div>

      </div>
    </section>
  </div>
</section>

{% endblock %}
{% block extra_js %}
<script>
  /* ============================
     UPDATED MATERIALS JS (Dashboard)
     - Materials-only changes
     ============================ */

  (function () {
    "use strict";

    /* ==============================
       UTILITIES CONFIG (YOUR ORDER)
       ============================== */
    const TAG_LABEL = {
      Masters: "MASTERS",
      Production: "PRODUCTION",
      Dyeing: "DYEING",
      Design: "DESIGN",
      Admin: "ADMIN TOOLS",
      Inventory: "INVENTORY",
      Dispatch: "DISPATCH",
      Accounts: "ACCOUNTS",
      Uploads: "UPLOADS",
    };

    // STRICT ROW ORDER + STRICT SPANS (8 columns base)
    const ROW_LAYOUT = {
      row1: [{ tag: "Masters", span: 8 }],
      row2: [{ tag: "Production", span: 5 }, { tag: "Dyeing", span: 3 }],
      row3: [{ tag: "Design", span: 8 }],
      row4: [
        { tag: "Admin", span: 2 },
        { tag: "Inventory", span: 2 },
        { tag: "Dispatch", span: 2 },
        { tag: "Accounts", span: 1 },
        { tag: "Uploads", span: 1 },
      ],
    };

    // Item order inside each section
    const INTRA_ORDER = {
      Masters: [
        "Firm", "Material / Trim", "Material Type", "Material Shades", "Material Unit", "Brand", "Category",
        "Main Category", "Sub Category", "Party", "Client", "Location", "Jobber Type", "Jobber", "Material Type Linking",
      ],
      Production: ["Techpack", "BOM", "Job Card Details", "Branch SKU"],
      Dyeing: ["Dyeing Master", "Greige Master", "Dyeing Other Charge Headers"],
      Design: ["Catalogue", "Pattern Type", "Designer", "Season", "Theme"],
      Admin: ["Jobber Bulk Changes"],
      Inventory: ["Inward Type"],
      Dispatch: ["Terms & Condition"],
      Accounts: ["Expense"],
      Uploads: ["Material Bulk Upload"],
    };

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function getPriority(tag, title) {
      const arr = INTRA_ORDER[tag] || [];
      const idx = arr.indexOf(title);
      return idx === -1 ? 999 : idx;
    }

    // KEEP YOUR ICON FUNCTION (unchanged style)
    function iconSvg(name) {
      const icons = {
        settings: `
      <svg class="ico" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
        <path d="M19.4 15a7.9 7.9 0 0 0 .1-6l2-1.5-2-3.5-2.3 1a8 8 0 0 0-5.2-2L11.5 1h-3L8 3a8 8 0 0 0-4.5 3L1 6.5l2 3.5 2-1.5a8.2 8.2 0 0 0 0 7L3 17l-2 3.5L3 22l2.5-1a8 8 0 0 0 5 2l1 2h3l.6-2a8 8 0 0 0 4.9-2l2.5 1 2-3.5-2.1-1z"/>
      </svg>`,
        jobber: `
        <svg class="ico icon-jobber" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(238, 61, 133, 1)" height="30px">
          <path d="M2 22C2 17.5817 5.58172 14 10 14C14.4183 14 18 17.5817 18 22H16C16 18.6863 13.3137 16 10 16C6.68629 16 4 18.6863 4 22H2ZM10 13C6.685 13 4 10.315 4 7C4 3.685 6.685 1 10 1C13.315 1 16 3.685 16 7C16 10.315 13.315 13 10 13ZM10 11C12.21 11 14 9.21 14 7C14 4.79 12.21 3 10 3C7.79 3 6 4.79 6 7C6 9.21 7.79 11 10 11ZM18.2837 14.7028C21.0644 15.9561 23 18.752 23 22H21C21 19.564 19.5483 17.4671 17.4628 16.5271L18.2837 14.7028ZM17.5962 3.41321C19.5944 4.23703 21 6.20361 21 8.5C21 11.3702 18.8042 13.7252 16 13.9776V11.9646C17.6967 11.7222 19 10.264 19 8.5C19 7.11935 18.2016 5.92603 17.041 5.35635L17.5962 3.41321Z"></path>
        </svg>`,
        jobberType: `
        <svg class="ico " viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 7h16"/>
          <path d="M4 12h10"/>
          <path d="M4 17h16"/>
          <path d="M18 12l2 2 3-3"/>
        </svg>
        `,
        material: `<svg class="ico icon-material" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000" height="800px" width="800px" version="1.1" id="Layer_1" viewBox="0 0 512 512" xml:space="preserve" stroke="#000000" stroke-width="26.112000000000002">

<g id="SVGRepo_bgCarrier" stroke-width="0"/>

<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"/>

<g id="SVGRepo_iconCarrier"> <g transform="translate(1 1)"> <g> <g> <path d="M470.043,287.976c-1.736-1.736-4.339-2.603-6.942-2.603c-15.62,0-27.769-4.339-37.315-14.753 c-26.034-26.902-23.431-79.837-23.431-80.705c0-96.325,24.298-143.186,25.166-143.186c0.868-2.603,0.868-5.207,0-7.81 s-3.471-4.339-6.075-5.207L256.565-1c-2.603,0-4.339,0-6.942,1.736s-3.471,4.339-3.471,6.942 c0,26.034-8.678,47.729-26.902,64.217c-53.803,49.464-170.956,39.919-171.824,39.919c-2.603,0-5.207,0.868-6.942,2.603 s-2.603,3.471-2.603,6.075v381.831c0,5.207,3.471,8.678,8.678,8.678h199.593c4.339,0,7.81-2.603,8.678-6.942l18.224-112.814 l25.166,112.814c0.868,4.339,4.339,6.942,8.678,6.942h130.169c4.339,0,7.81-3.471,8.678-7.81l26.034-208.271 C472.647,292.315,471.779,289.712,470.043,287.976z M429.257,493.644H313.84l-32.976-149.261 c-0.868-4.339-4.339-6.942-8.678-6.942c-4.339,0-7.81,2.603-8.678,6.942l-24.298,149.261H55.237V241.983h8.678 c5.207,0,8.678-3.471,8.678-8.678c0-5.207-3.471-8.678-8.678-8.678h-8.678v-94.59c30.373,0.868,124.963,0.868,175.295-45.993 c19.092-17.356,29.505-39.919,32.109-65.953l144.922,31.241c-7.81,19.091-22.563,65.085-22.563,140.583 c0,0.869-0.653,15.895,2.623,34.712h-11.301c-5.207,0-8.678,3.471-8.678,8.678c0,5.207,3.471,8.678,8.678,8.678h15.34 c4.201,14.136,10.996,28.635,21.975,39.919c10.414,11.281,24.298,18.224,39.919,19.959L429.257,493.644z"/> <path d="M150.694,224.627h-34.712c-5.207,0-8.678,3.471-8.678,8.678c0,5.207,3.471,8.678,8.678,8.678h34.712 c5.207,0,8.678-3.471,8.678-8.678C159.372,228.098,155.901,224.627,150.694,224.627z"/> <path d="M324.253,224.627h-34.712c-5.207,0-8.678,3.471-8.678,8.678c0,5.207,3.471,8.678,8.678,8.678h34.712 c5.207,0,8.678-3.471,8.678-8.678C332.931,228.098,329.46,224.627,324.253,224.627z"/> <path d="M237.474,224.627h-34.712c-5.207,0-8.678,3.471-8.678,8.678c0,5.207,3.471,8.678,8.678,8.678h34.712 c5.207,0,8.678-3.471,8.678-8.678C246.152,228.098,242.681,224.627,237.474,224.627z"/> </g> </g> </g> </g>

</svg>`
      };


      return icons[name] || icons.settings;
    }

    // ✅ COMPLETE UTILITIES LIST (so rows don’t break)
    const UTILITIES = [
      // Masters
      { title: "Firm", tag: "Masters", key: "firm" },
      { title: "Material / Trim", tag: "Masters", key: "material trim", icon: "material" },
      { title: "Material Type", tag: "Masters", key: "material type" },
      { title: "Material Shades", tag: "Masters", key: "shade shades" },
      { title: "Material Unit", tag: "Masters", key: "unit uom" },
      { title: "Brand", tag: "Masters", key: "brand" },
      { title: "Category", tag: "Masters", key: "category" },
      { title: "Main Category", tag: "Masters", key: "main category" },
      { title: "Sub Category", tag: "Masters", key: "sub category" },
      { title: "Party", tag: "Masters", key: "party" },
      { title: "Client", tag: "Masters", key: "client" },
      { title: "Location", tag: "Masters", key: "location" },
      { title: "Jobber Type", tag: "Masters", key: "jobber type" },
      { title: "Jobber", tag: "Masters", key: "jobber", icon: "jobber" },
      { title: "Material Type Linking", tag: "Masters", key: "type linking" },

      // Production
      { title: "Techpack", tag: "Production", key: "techpack" },
      { title: "BOM", tag: "Production", key: "bom" },
      { title: "Job Card Details", tag: "Production", key: "job card" },
      { title: "Branch SKU", tag: "Production", key: "branch sku" },

      // Dyeing
      { title: "Dyeing Master", tag: "Dyeing", key: "dyeing" },
      { title: "Greige Master", tag: "Dyeing", key: "greige" },
      { title: "Dyeing Other Charge Headers", tag: "Dyeing", key: "other charge headers" },

      // Design
      { title: "Catalogue", tag: "Design", key: "catalogue" },
      { title: "Pattern Type", tag: "Design", key: "pattern type" },
      { title: "Designer", tag: "Design", key: "designer" },
      { title: "Season", tag: "Design", key: "season" },
      { title: "Theme", tag: "Design", key: "theme" },

      // Admin / Inventory / Dispatch / Accounts / Uploads
      { title: "Jobber Bulk Changes", tag: "Admin", key: "jobber bulk changes" },
      { title: "Inward Type", tag: "Inventory", key: "inward type grn" },
      { title: "Terms & Condition", tag: "Dispatch", key: "terms condition" },
      { title: "Expense", tag: "Accounts", key: "expense" },
      { title: "Material Bulk Upload", tag: "Uploads", key: "material bulk upload" },
    ];

    // ROUTES (keep your names)
    const ROUTES = {
      "Jobber": "{% url 'accounts:jobber_list' %}",
      "Jobber Type": "{% url 'accounts:jobbertype_list' %}",
      "Material / Trim": "{% url 'accounts:material_list' %}",
      "Party": "{% url 'accounts:party_list' %}", //
    };

    function tileHtml(u) {
      const href = ROUTES[u.title] || "#";
      return `
      <a class="util-tile" href="${href}" data-title="${escapeHtml(u.title)}" data-tag="${escapeHtml(u.tag)}">
        <span class="util-ico">${iconSvg(u.icon)}</span>
        <div class="util-meta">
          <div class="util-title">${escapeHtml(u.title)}</div>
        </div>
      </a>
    `;
    }

    // ✅ groupHtml now supports SPAN to prevent cramping
    function groupHtml(tag, items, span) {
      const label = TAG_LABEL[tag] || tag.toUpperCase();

      const inlinePanel = (tag === "Masters") ? `
      <div id="mastersEmbedPanel" class="util-inline-panel" style="display:none;">
        <div id="mastersEmbedMount"></div>
      </div>
    ` : "";

      return `
      <div class="util-group" data-tag="${escapeHtml(tag)}" style="grid-column: span ${span}; --cols:${span};">
        <div class="util-group-head">
          <div class="util-group-title">${escapeHtml(label)}</div>
          <div class="util-group-line"></div>
          <div class="util-group-count">${items.length}</div>
        </div>

        ${inlinePanel}

        <div class="util-group-grid">
          ${items.map(tileHtml).join("")}
        </div>
      </div>
    `;
    }

    let LAST_MASTERS_URL = null; // remembers currently opened embed page

    // resolve embed URL against LAST_MASTERS_URL so ?page=2 / relative links work
    function withEmbed(url) {
      const base = LAST_MASTERS_URL || window.location.origin;
      const u = new URL(url, base);
      u.searchParams.set("embed", "1");
      return u.toString();
    }

    function isMastersUrl(hrefOrAction) {
      if (!hrefOrAction) return false;

      const base = LAST_MASTERS_URL || window.location.origin;

      let urlObj;
      try {
        urlObj = new URL(hrefOrAction, base);
      } catch {
        return false;
      }

      const path = (urlObj.pathname || "").replace(/\/+$/, "") + "/";

      const routeJobber = ROUTES["Jobber"] ? new URL(ROUTES["Jobber"], window.location.origin).pathname.replace(/\/+$/, "") + "/" : "";
      const routeType = ROUTES["Jobber Type"] ? new URL(ROUTES["Jobber Type"], window.location.origin).pathname.replace(/\/+$/, "") + "/" : "";
      const routeMaterial = ROUTES["Material / Trim"] ? new URL(ROUTES["Material / Trim"], window.location.origin).pathname.replace(/\/+$/, "") + "/" : "";
      const routeParty = ROUTES["Party"] ? new URL(ROUTES["Party"], window.location.origin).pathname.replace(/\/+$/, "") + "/" : "";
      const prefixes = [
        "/master/jobbers/",
        "/master/jobber-types/",
        "/master/materials/",
        "/master/parties/",
        routeJobber,
        routeType,
        routeMaterial,
        routeParty, 
      ].filter(Boolean);

      return prefixes.some((p) => path.startsWith(p));
    }

    function bootUtilities() {
      const container = document.getElementById("utilSections");
      const input = document.getElementById("utilSearch");
      if (!container || !input) return;

      // Close handler from embedded pages
      container.addEventListener("click", (e) => {
        const closeBtn = e.target.closest("[data-embed-close]");
        if (!closeBtn) return;

        const panel = container.querySelector("#mastersEmbedPanel");
        const mount = container.querySelector("#mastersEmbedMount");
        if (!panel || !mount) return;

        panel.style.display = "none";
        mount.innerHTML = "";
      });

      // ==========================
      // MATERIALS ONLY: initEmbedMount
      // - Step1: only 4 options, nothing else visible
      // - Step2: show only selected type fields
      // - Disable hidden fields to prevent browser blocking save
      // - Image preview
      // ==========================
      function initEmbedMount(mount, contextUrl) {
        if (!mount) return;

        // ===== MATERIALS LIST FILTER (stay inside embed) =====
        const materialsList = mount.querySelector(".materials-embed"); // CHANGED
        if (materialsList) { // CHANGED
          const listForm = materialsList.querySelector("form.mat-search"); // CHANGED
          const selects = listForm ? listForm.querySelectorAll('select[name="type"]') : null; // CHANGED
          const typeSelect = (selects && selects.length) ? selects[selects.length - 1] : null; // CHANGED (handles nested/duplicate selects safely)
          if (listForm && typeSelect && !typeSelect.dataset.bound) { // CHANGED
            typeSelect.dataset.bound = "1"; // CHANGED
            typeSelect.removeAttribute("onchange"); // CHANGED (prevents inline this.form.submit() which bypasses submit event)
            typeSelect.onchange = null; // CHANGED
            typeSelect.addEventListener("change", () => { // CHANGED
              if (typeof listForm.requestSubmit === "function") { // CHANGED
                listForm.requestSubmit(); // CHANGED (fires submit event so embed submit handler intercepts)
              } else { // CHANGED
                listForm.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true })); // CHANGED (fallback)
              }
            }); // CHANGED
          }
        }
        // ===== END MATERIALS LIST FILTER FIX =====

        const formWrap = mount.querySelector("[data-material-form]");
        if (!formWrap) return;

        const step2 = formWrap.querySelector("[data-step2]");
        if (!step2) return;

        const ALLOWED_TYPES = new Set(["yarn", "greige", "finished", "trim"]);

        const hasErrors = !!formWrap.querySelector(".mat-errors, .errorlist, [aria-invalid='true']");
        const ctx = String(contextUrl || "");
        const isAdd = ctx.includes("/master/materials/add");
        const isEdit = ctx.includes("/edit/");

        const typeEl = formWrap.querySelector('[name="material_type"]');

        function ensureOnly4Options_Select(selectEl) {
          if (!selectEl) return;

          // hide everything except allowed 4
          Array.from(selectEl.options).forEach((opt) => {
            const v = (opt.value || "").trim();
            if (!ALLOWED_TYPES.has(v)) opt.hidden = true;
          });

          // ensure hidden placeholder exists so Step2 stays hidden until user selects
          let placeholder = selectEl.querySelector('option[value=""]');
          if (!placeholder) {
            placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Select";
            placeholder.disabled = true;
            placeholder.hidden = true; // not visible -> still only 4 visible options
            selectEl.insertBefore(placeholder, selectEl.firstChild);
          } else {
            placeholder.disabled = true;
            placeholder.hidden = true;
          }

          // On add screen (fresh), force no selection
          if (isAdd && !isEdit && !hasErrors) {
            placeholder.selected = true;
            selectEl.value = "";
          }
        }

        function ensureOnly4Options_Radios() {
          const radios = Array.from(formWrap.querySelectorAll('input[type="radio"][name="material_type"]'));
          if (!radios.length) return;

          radios.forEach((r) => {
            if (!ALLOWED_TYPES.has((r.value || "").trim())) {
              // hide radio + its label container if possible
              const wrap = r.closest("label") || r.parentElement;
              if (wrap) wrap.style.display = "none";
              r.checked = false;
            }
          });

          // On add screen (fresh), force none checked
          if (isAdd && !isEdit && !hasErrors) {
            radios.forEach((r) => { r.checked = false; });
          }
        }

        // Disable/enable helpers to prevent hidden required fields blocking submit
        function primeReqState(el) {
          if (el.dataset.reqInit === undefined) {
            el.dataset.reqInit = el.required ? "1" : "0";
          }
        }

        function setEnabled(root, enabled) {
          const ctrls = root.querySelectorAll("input, select, textarea, button");
          ctrls.forEach((el) => {
            // never disable material_type control itself
            if (el.name === "material_type") return;

            if (el.matches("input, select, textarea")) {
              primeReqState(el);
              if (!enabled) el.required = false;
              else el.required = (el.dataset.reqInit === "1");
            }

            el.disabled = !enabled;
          });
        }

        const sections = Array.from(formWrap.querySelectorAll(".mf-section[data-type]"));

        function detectValue() {
          const el = formWrap.querySelector('[name="material_type"]');
          if (!el) return "";

          if (el.tagName === "SELECT") return (el.value || "").trim();

          const checked = formWrap.querySelector('[name="material_type"]:checked');
          return checked ? (checked.value || "").trim() : "";
        }

        function showType(val) {
          const v = (val || "").trim();
          const ok = ALLOWED_TYPES.has(v);

          if (!ok) {
            step2.style.display = "none";
            // disable everything in step2 so required fields don't block submit
            setEnabled(step2, false);
            sections.forEach((s) => { s.style.display = "none"; });
            return;
          }

          step2.style.display = "block";
          // enable step2 common controls first
          setEnabled(step2, true);

          sections.forEach((s) => {
            const active = (s.dataset.type === v);
            s.style.display = active ? "block" : "none";
            // critical: disable controls in hidden sections
            setEnabled(s, active);
          });
        }

        // 1) enforce ONLY 4 options visible (Materials only)
        if (typeEl && typeEl.tagName === "SELECT") ensureOnly4Options_Select(typeEl);
        else ensureOnly4Options_Radios();

        // 2) bind change
        formWrap.addEventListener("change", (e) => {
          if (e.target && e.target.name === "material_type") {
            showType(detectValue());
          }
        });

        // 3) initial state: Step2 hidden until selection (unless edit / errors)
        showType(detectValue());

        // 4) image preview (Materials only)
        const fileInput = formWrap.querySelector('input[type="file"]');
        const preview = formWrap.querySelector("#matPreview");
        if (fileInput && preview && !fileInput.dataset.bound) {
          fileInput.dataset.bound = "1";
          fileInput.addEventListener("change", () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
              preview.innerHTML = `<img src="${ev.target.result}" alt="preview">`;
            };
            reader.readAsDataURL(file);
          });
        }
      }

      // open embed + init materials logic after load
      function openMastersPanel(title, url) {
        const panel = container.querySelector("#mastersEmbedPanel");
        const mount = container.querySelector("#mastersEmbedMount");
        if (!panel || !mount) return;

        panel.style.display = "block";
        mount.innerHTML = `<div class="tiny-note">Loading…</div>`;

        const base = LAST_MASTERS_URL || window.location.origin;
        const absUrl = new URL(url, base).toString();
        LAST_MASTERS_URL = absUrl;

        fetch(withEmbed(absUrl), {
          headers: { "X-Requested-With": "XMLHttpRequest" },
          credentials: "same-origin",
        })
          .then((r) => r.text())
          .then((html) => {
            mount.innerHTML = html;
            initEmbedMount(mount, absUrl); // Materials-only init (no-op for others)
          });
      }

      // delegate clicks inside embed (pagination, links)
      container.addEventListener("click", (e) => {
        const panel = container.querySelector("#mastersEmbedPanel");
        const mount = container.querySelector("#mastersEmbedMount");
        if (!panel || !mount || panel.style.display === "none") return;

        const a = e.target.closest("a");
        if (!a) return;

        const href = a.getAttribute("href") || "";
        if (isMastersUrl(href)) {
          e.preventDefault();
          openMastersPanel("Masters", href);
        }
      });

      // delegate submits inside embed
      container.addEventListener("submit", async (e) => {
        const form = e.target.closest("form");
        if (!form) return;

        // Materials-only: allow empty action by resolving to LAST_MASTERS_URL
        const isMaterialsForm =
          !!form.closest(".material-form-embed") ||
          !!form.closest(".materials-embed") ||
          !!form.querySelector("[data-material-form]") ||
          !!form.closest("[data-material-form]");

        const actionAttr = (form.getAttribute("action") || "").trim();
        const resolvedAction = (isMaterialsForm && !actionAttr)
          ? (LAST_MASTERS_URL || window.location.href)
          : (actionAttr || "");

        if (!isMastersUrl(resolvedAction)) return;

        e.preventDefault();

        const mount = container.querySelector("#mastersEmbedMount");
        if (!mount) return;

        const method = (form.getAttribute("method") || "GET").toUpperCase();

        if (method === "GET") {
          const params = new URLSearchParams(new FormData(form));
          const baseUrl = resolvedAction.split("?")[0];
          openMastersPanel("Masters", baseUrl + "?" + params.toString());
          return;
        }

        const fd = new FormData(form);
        const res = await fetch(withEmbed(resolvedAction), {
          method,
          body: fd,
          headers: { "X-Requested-With": "XMLHttpRequest" },
          credentials: "same-origin",
        });

        const ct = (res.headers.get("content-type") || "").toLowerCase();

        if (ct.includes("application/json")) {
          const data = await res.json();
          if (data.ok && data.url) {
            openMastersPanel("Masters", data.url);
            return;
          }
        }

        mount.innerHTML = await res.text();
        initEmbedMount(mount, resolvedAction); // Materials-only init (no-op for others)
      });

      function render(query) {
        const q = (query || "").toLowerCase().trim();

        const filtered = UTILITIES.filter((u) => {
          if (!q) return true;
          const hay = `${u.title} ${u.tag} ${u.key}`.toLowerCase();
          return hay.includes(q);
        });

        // Group
        const groups = {};
        for (const u of filtered) (groups[u.tag] ||= []).push(u);

        // Sort inside group
        Object.keys(groups).forEach((tag) => {
          groups[tag].sort((a, b) => {
            const pa = getPriority(tag, a.title);
            const pb = getPriority(tag, b.title);
            if (pa !== pb) return pa - pb;
            return a.title.localeCompare(b.title);
          });
        });

        // Build rows STRICTLY (keep structure even if empty => NO CRAM)
        const buildRow = (rowSpec, rowClass) => {
          const html = rowSpec.map(({ tag, span }) => groupHtml(tag, groups[tag] || [], span)).join("");
          return `<div class="util-row ${rowClass}">${html}</div>`;
        };

        container.innerHTML = `
        <div class="util-layout">
          ${buildRow(ROW_LAYOUT.row1, "util-row-1")}
          ${buildRow(ROW_LAYOUT.row2, "util-row-2")}
          ${buildRow(ROW_LAYOUT.row3, "util-row-3")}
          ${buildRow(ROW_LAYOUT.row4, "util-row-4")}
        </div>
      `;

        // Tile clicks
        container.querySelectorAll(".util-tile").forEach((tile) => {
          tile.addEventListener("click", (e) => {
            const title = tile.dataset.title || "";
            const href = tile.getAttribute("href") || "#";

            // Only these open embed for now
            if (title === "Jobber" || title === "Jobber Type" || title === "Material / Trim" || title === "Party") {
              e.preventDefault();
              openMastersPanel(title, href);
              return;
            }

            // keep no navigation for others (your requirement)
            e.preventDefault();
          });
        });
      }

      render("");
      input.addEventListener("input", () => render(input.value));
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bootUtilities);
    } else {
      bootUtilities();
    }
  })();
</script>
{% endblock %}
